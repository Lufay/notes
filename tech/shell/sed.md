# sed
[TOC]

非交互式的编辑器

## 行为
逐行处理：把当前行存储在临时缓冲区中（pattern space）进行处理（应用所有指定的命令），处理完后将缓冲区内容输出，而后下一行，直到文件尾。
**也就是说并不改变源文件**

## 格式
```
sed -option 'command' file
```
file指定操作的文件，如果未指定则从stdin获取

### 选项
+ -n
安静模式，处理结束后不再输出pattern space，但不会影响未加入pattern space的内容
+ -e
可以用于指定多条命令（对于pattern space逐命令处理），每个命令一个，如果只有一个命令则可省
+ -f scriptfile
可以指定执行脚本文件
该文件可以使用`#`注释，如果第一行可以写上`#!/bin/sed -f` 并给文件以执行权限，就可以直接用该脚本名进行调用
+ -r
使用扩展的正则
+ -i[xxx]
不再输出，直接修改源文件，如果给了xxx，则将源文件的内容保存为原文件名加xxx的后缀的文件

### sed脚本
sed的命令是由动作组成的，动作间用分号“;”或换行分隔
动作由“定址”和“指令”组成

#### 定址
表示指令的作用范围，缺省则视为对所有行应用
可以是以下形式：
+ 行号（$表示最后一行）
+ /reg/

也可以是它们组合，并用逗号分割表示一个范围
也可以跟 ! 表示除指定行外应用

*注*
如果想变更这里reg的分隔符 / ，先对指定字符进行转义即可，例如使用o：
```
\o正则表达式o
```
#### 指令
`=`：输出行号，不受-n影响
`p`：输出当前行，不受-n影响
`P`：输出pattern space中的第一行
`l`：输出当前行，控制字符明文显示，不受-n影响
`s`：行内替换
`a`：当前行后追加，增加的内容不受后续动作影响，也不受-n影响（标准是只支持单行定址，实际是如果使用多行，则在每行都增加）
`i`：当前行前插入，增加的内容不受后续动作影响，也不受-n影响（标准是只支持单行定址，实际是如果使用多行，则在每行都增加）
`d`：删除当前行，因为pattern space清空，所以后续动作都不再执行，并且也不会有输出
`D`：删除pattern space中的第一行，如果pattern space未清空，就直接用当前pattern space重新执行所有命令（而不再读取新行）
`c`：行替换（多行定址则一次性替换多行），替换的内容不受后续动作影响，也不受-n影响
`h`：把pattern space中的内容复制到暂存缓冲区（hold space）
`H`：把pattern space中的内容追加到暂存缓冲区，用\n分割
`g`：把暂存缓冲区中的内容覆盖当前pattern space
`G`：把暂存缓冲区中的内容追加到当前pattern space，用\n分割
`x`：交换pattern space和暂存缓冲区
`n`：结束当前行的处理，进行pattern space的输出，读入下一行
`N`：读入下一行，追加到pattern space，多行用\n分割，如果是已经最后一行，将导致结束后续处理，进行pattern space的输出，而后退出，因此通常使用$!N避免最后一行执行该指令
`q`：退出sed，但仍然会输出当前行
`r`：当输出完当前行，读取文件并输出，后跟文件名，只支持单行定址，输出的内容不受后续动作影响，也不受-n影响
`w`：将指定的行写入文件（受已执行的处理影响），后跟文件名
`W`：将pattern space中的第一行写入文件，后跟文件名
`b`：分支到指定的标记位置，后跟一个标记，标记不存在则分支到脚本的末尾（标记定义 :tag 独立一行）
`t`：测试条件，判断前面的行内替换是否成功，如果成功就分支到指定标记位置或脚本末尾，后跟一个标记
`T`：错误分支，从最后一行开始一旦发生错误，就分支到指定标记位置或脚本末尾，后跟一个标记

##### 指令说明
1. 指令可以是“{}”这种指令块，其中可以嵌套动作（“定址”+“指令”）
1. 行内替换同vim，`s/reg/sub/flag`
其中如果reg或str中如有 / 可以使用 \ 进行转义，也可以将 / 替换为其他分隔符（\除外）。
如果使用单个正则定址，而第一个替换命令的reg正好也是该正则，则reg可省。
替换选项flag:
	`g`全部替换
	`1-512`表示替换次数
	`p`当匹配命中，则打印pattern space内容
	`w file`当匹配命中时，将pattern space内容写到文件file中
1. 追加a、插入i、行替换c、读r、写w 的内容是后面紧跟的文本滤除开头的空白符
*注*：空白符不包括被 \ 转义的空白符，如果这个转义的空白符是换行，则该换行不包含在内容中。
另外因为分号“;”以及指令块“{}”也会被视为内容，所有要和后续的动作分隔必须使用换行，即“}”需要另起一行）
而如果包含多行内容，避免换行被误认为动作分隔符，需使用 \ 转义，因此如果需要保留内容部分的开头空白符，可以：
```
a \
    line1 \
    line2
```
1. `y/abcd/ABCD/`，类似tr命令，按照字符一对一进行转换（同s指令一样，/ 可以替换为其他分隔符）
1. 如果一个动作的修改是对pattern space的修改，则会对后续动作有影响（注意命令顺序）；如果只是附加输出（aicr），则后续动作不会影响到附加的内容

###### sed的's/reg/sub/g' 正则说明
由于默认使用的是BRE，所以
要使用`\(str\)`表示保存str串（而不是直接的括号）
可以在替换串sub中使用`\1、\2 ... \9` 进行引用，此外还可以使用 `&` 引用匹配整个reg的串

