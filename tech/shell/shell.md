# shell
[TOC]

## 注释
`#`		行注释（行首的 `#!` 有特别意义）

## 语句
`:`		空命令，等价于NOP（类似Python的pass作为占位符），返回值为0（类似于true命令）

### 串联语句
`;`		命令分隔符，等价于换行符
`&&`	当左侧一个命令的`$?` 为0（可视为真，执行成功）时才执行右侧命令，左侧的`$?` 为1则右边都不执行
`||`	当左侧一个命令的`$?` 为1（可视为假，执行失败）时才执行右侧命令，左侧的`$?` 为0则右边都不执行
`|`		使用管道

### 语句块
$? 为最后一条命令的返回
+ `(cmd1;cmd2;cmd3)`
新开一个子shell顺序执行命令cmd1,cmd2,cmd3, 各命令之间用分号隔开, 最后一个命令后可以没有分号
+ `{ cmd1;cmd2;cmd3;}`
在当前shell顺序执行命令cmd1,cmd2,cmd3, 各命令之间用分号隔开, 最后一个命令后必须有分号; 第一条命令和左括号之间必须用空格隔开

### if
```
if STAT1
then
	BLOCK1
elif STAT2
then
	BLOCK2
else
	BLOCK
fi
```
其中STAT? 可以是任意一条语句，if 会根据其返回值$? 判断是否执行

#### 条件判断语句
test 命令支持字符串、整数、文件三类测试
1. 字符串
`=` 和`==` 等价
`!=`
`-z` 空串、`-n` 非空串
1. 整数
`-eq`、`-ne`
`-gt`、`-lt`
`-ge`、`-le`
1. 文件
`-e` 存在、`-s` 非空文件、`-f` 普通文件、`-d` 目录、`-L` 符号链接、`-b` 块设备、`-c` 字符设备、`-p` PIPE或FIFO
`-r` 可读、`-w` 可写、`-x` 可执行、`-u` SUID、`-g` SGID、`-k` sticky bit
-nt 前者比后者新、-ot 前者比后者旧、-ef 同一个文件（link）
1. 其他
`!`、`-a`、`-o`

`test -option expr`命令，等价于`[ -option expr ]` 结构
通过type 命令查看，"test" 和"[" 都是内置命令
+ 命令和运算符、各运算符直接之间需要用空格隔开，所以括号内两侧、各部分之间需空格隔开
+ 命令后的`<`、`>` 会被视为重定向，所以必须使用`\`进行转义（表示字符串比较）
+ 由于`]` 表示`[` 命令的结束，所以`&&` 和`||` 这种命令分隔符必须在括号之外；括号内可以使用`-a` 和`-o` 连接
+ 命令中的变量会首先被求值，再用得到的字符串（可能没有）执行命令，所以为了避免空字符串被忽略，应给变量加双引号

为了对该结构进行增强，很多shell 都引入了`[[ expr ]]` 结果
通过type 命令查看，"[[" 都是关键字（和if 一样）
1. 变量无需加双引号
1. 直接支持使用`<`、`>`、`&&` 和`||`（取消支持`-a` 和`-o`）
1. 支持整数运算
1. `=`、`==`、`!=` 支持通配符（包含通配符的字符串不加引号）；`=~` 支持正则

如果要测试一个整数运算的值，还可以使用`((expr))`结构
expr 是一个整数运算表达式（参考let，支持比较），值非0 返回0，否则返回1

还有两个特别的命令true、false，总是返回0、1

### case
```
case $var in
	PATTERN1 )
		BLOCK1
		;;
	PATTERN2 )
		BLOCK2
		;;
	* )
		BLOCK
		;;
esac
```
PATTERN? 可以是用`|` 分割的多个子模式，模式中可以使用通配符

### 循环
支持`break [N]`和`continue [N]`，N 表示跳出几层循环，默认是1

#### while 和 until
条件为真，则循环
```
while STAT
do
	BLOCK
done
```
STAT 参考上面的if

条件为假，则循环
```
until STAT
do
	BLOCK
done
```


#### for
```
for i in `seq 0 4`;do echo $i;done
for i in {0..4};do echo $i;done
for ((i=0;i<5;i++));do echo $i;done
```
in 后面可以跟一个由空白符分隔的多个字符串

### exit
`exit n`
n 可省，默认是0，退出脚本返回n


## 函数
```
function func_name() {
	# do things
	return xxx;
}
```
其中关键字function 或 小括号其一是可以缺省（参数并不从括号中传入）
如果没有return 语句，则返回值使用最后一条命令的返回值

在shell 中定义的函数，可以相当于一个自定义命令：
1. 调用方式类似命令（参数空格分隔）
函数调用必须在函数定义之后
1. 函数体内参数获取，类似命令：$0, $1, $2, ...
1. 函数体的局部变量用local 声明，其他的都是全局变量
1. 函数的返回值通过 $? 获得（所以返回值必须是一个0 到255 直接的整数）
1. 可以使用$() 获得其输出，也可以进行输出重定向
1. 函数名如果可以和外部命令重名，这样函数定义覆盖外部命令功能，如果想要恢复，可以使用`unset -f func_name` 删除函数
函数名可以重复定义，类似变量的值，功能采用最近的一次定义

### 查看函数
```
declare –f func_name
```
查看函数的定义，如果`func_name`缺省，则查看所有函数的定义

```
declare –F
```
查看所有函数的函数名


## 包含其他文件
source

`.`		等价于source命令

它跟exec 命令的相同点都是不产生新的进程，区别是exec 是将其指定的执行代码覆盖后续的代码，也就是不会返回再执行后续代码了，除非exec 没有指定执行代码，而仅仅只是描述符重定向